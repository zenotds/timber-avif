{# Reactive image #}
{% macro image(image, options = {}) %}
    {% set defaults = {
        sizes: null,
        breakpoints: {
            'xs': '0rem',
            'sm': '40rem',
            'md': '48rem',
            'lg': '64rem',
            'xl': '80rem',
            '2xl': '96rem'
        },
        pictureClass: '',
        imgClass: 'object-cover object-center h-full w-full mx-auto',
        atf: false,
        avif: true,
        webp: true
    } %}

    {% set config = defaults|merge(options) %}

    {# Simple render when no responsive sizes are provided #}
    {% if config.sizes is null %}
        <picture class="picture {{ config.pictureClass }}">
            {% set avifUrl = config.avif ? (image|avif_src) : null %}
            {% set webpUrl = config.webp ? (image|webp_src) : null %}
            {% if config.avif %}
                <source srcset="{{ avifUrl ?: (image|toavif) }}" type="image/avif"/>
            {% endif %}
            {% if config.webp %}
                <source srcset="{{ webpUrl ?: (image|towebp) }}" type="image/webp"/>
            {% endif %}
            <img {% if config.imgClass %} class="{{ config.imgClass }}" {% endif %} src="{{ image.url }}" alt="{{ image.alt ?: image.title }}" {% if config.atf %} fetchpriority="high" {% else %} loading="lazy" decoding="async" {% endif %} {% if image.width %} width="{{ image.width }}" {% endif %} {% if image.height %} height="{{ image.height }}" {% endif %}/>
        </picture>
    {% else %}

        {% set maxResize = 2560 %}
        {% set imageWidth = image.width %}
        {% set imageHeight = image.height %}

        {% set maxDimension = imageWidth > imageHeight ? imageWidth : imageHeight %}
        {% set scaleFactor = maxDimension > maxResize ? (maxResize / maxDimension) : 1 %}

        {# Normalize sizes: carry forward last defined size for each breakpoint #}
        {% set bpKeys = ['xs', 'sm', 'md', 'lg', 'xl', '2xl'] %}
        {% set normalizedSizes = {} %}
        {% set lastSize = [imageWidth] %}
        {% for key in bpKeys %}
            {% if config.sizes[key] is defined %}
                {% set lastSize = config.sizes[key] %}
            {% endif %}
            {% set normalizedSizes = normalizedSizes|merge({(key): lastSize}) %}
        {% endfor %}

        {# Source configs: largest to smallest, min-width only (mobile-first) #}
        {% set sourceConfigs = [
            {
                'key': '2xl',
                'media': '(min-width: ' ~ config.breakpoints['2xl'] ~ ')'
            },
            {
                'key': 'xl',
                'media': '(min-width: ' ~ config.breakpoints.xl ~ ')'
            },
            {
                'key': 'lg',
                'media': '(min-width: ' ~ config.breakpoints.lg ~ ')'
            },
            {
                'key': 'md',
                'media': '(min-width: ' ~ config.breakpoints.md ~ ')'
            },
            {
                'key': 'sm',
                'media': '(min-width: ' ~ config.breakpoints.sm ~ ')'
            },
            {
                'key': 'xs',
                'media': null
            }
        ] %}

        {% set pictureSources = [] %}

        {% for source in sourceConfigs %}
            {% set dims = normalizedSizes[source.key] %}
            {% set targetWidth = (dims[0] is defined ? dims[0] : imageWidth) * scaleFactor %}
            {% set targetHeight = dims[1] is defined ? dims[1] * scaleFactor : null %}

            {# Cap 2x at original dimensions to avoid useless upscaling #}
            {% set w2x = min(targetWidth * 2, imageWidth) %}
            {% set h2x = targetHeight ? min(targetHeight * 2, imageHeight) : null %}
            {% set has2x = w2x > targetWidth %}

            {% set src1x = image|resize(targetWidth, targetHeight) %}
            {% set src2x = has2x ? image|resize(w2x, h2x) : null %}

            {% set avif1x = config.avif ? (image|avif_src(targetWidth, targetHeight)) : null %}
            {% set avif2x = (config.avif and has2x) ? (image|avif_src(w2x, h2x)) : null %}
            {% set webp1x = config.webp ? (image|webp_src(targetWidth, targetHeight)) : null %}
            {% set webp2x = (config.webp and has2x) ? (image|webp_src(w2x, h2x)) : null %}

            {% set pictureSources = pictureSources|merge([{
                'media': source.media,
                'has2x': has2x,
                'src1x': src1x,
                'src2x': src2x,
                'avif1x': avif1x,
                'avif2x': avif2x,
                'webp1x': webp1x,
                'webp2x': webp2x
            }]) %}
        {% endfor %}

        {% set baseSize = normalizedSizes['2xl'] %}
        {% set baseWidth = baseSize[0] %}
        {% set baseHeight = baseSize[1] is defined ? baseSize[1] : null %}

        {# Determine best available format (server-side) #}
        {% set baseAvif = config.avif ? (image|avif_src) : null %}
        {% set baseWebp = config.webp ? (image|webp_src) : null %}
        {% set hasAvif = baseAvif and (baseAvif ends with '.avif') %}
        {% set hasWebp = baseWebp and (baseWebp ends with '.webp') %}
        {% set useAvif = hasAvif %}
        {% set useWebp = (not useAvif) and hasWebp %}

        <picture class="picture {{ config.pictureClass }}">
            {# Preferred format (AVIF > WebP). We emit only one optimized format set #}
            {% if useAvif %}
                {% for source in pictureSources %}
                    <source {% if source.media %} media="{{ source.media }}" {% endif %} srcset="{{ (source.avif1x ?: source.src1x|toavif) }}{% if source.has2x %} 1x, {{ (source.avif2x ?: source.src2x|toavif) }} 2x{% endif %}" type="image/avif"/>
                {% endfor %}
            {% elseif useWebp %}
                {% for source in pictureSources %}
                    <source {% if source.media %} media="{{ source.media }}" {% endif %} srcset="{{ (source.webp1x ?: source.src1x|towebp) }}{% if source.has2x %} 1x, {{ (source.webp2x ?: source.src2x|towebp) }} 2x{% endif %}" type="image/webp"/>
                {% endfor %}
            {% endif %}

            {# Original format sources - fallback #}
            {% for source in pictureSources %}
                <source {% if source.media %} media="{{ source.media }}" {% endif %} srcset="{{ source.src1x }}{% if source.has2x %} 1x, {{ source.src2x }} 2x{% endif %}"/>
            {% endfor %}

            {# Fallback img tag #}
            <img {% if config.imgClass %} class="{{ config.imgClass }}" {% endif %} src="{{ image|resize(baseWidth, baseHeight) }}" alt="{{ image.alt ?: image.title }}" {% if config.atf %} fetchpriority="high" {% else %} loading="lazy" decoding="async" {% endif %} width="{{ baseWidth }}" {% if baseHeight %} height="{{ baseHeight }}" {% endif %}/>
        </picture>
    {% endif %}
{% endmacro %}
