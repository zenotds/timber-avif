{#
  Timber AVIF v3.0 Optimized Responsive Image Macro

  Improvements over v2.5:
  - Correct HTML structure (separate <source> per type)
  - Option to use |smart filter for automatic format selection
  - Optimized for v3.0 pre-generation
  - Better browser fallback chain
#}

{% macro image(image, options = {}) %}
    {% set defaults = {
        sizes: null,
        breakpoints: {
            'xs': '0rem',
            'sm': '40rem',
            'md': '48rem',
            'lg': '64rem',
            'xl': '80rem',
            '2xl': '96rem'
        },
        pictureClass: '',
        imgClass: 'object-cover object-center h-full w-full mx-auto',
        loading: 'lazy',
        decoding: 'async',
        avif: true,
        webp: true,
        smart: false  {# NEW: Use |smart filter instead of separate formats #}
    } %}

    {% set config = defaults|merge(options) %}

    {# Simple render when no responsive sizes are provided #}
    {% if config.sizes is null %}
        <picture class="picture {{ config.pictureClass }}">
            {% if config.smart %}
                {# Using smart filter - automatic format selection #}
                <img {% if config.imgClass %} class="{{ config.imgClass }}" {% endif %}
                     src="{{ image|smart }}"
                     {% if image.title %} alt="{{ image.title }}" {% endif %}
                     {% if config.loading %} loading="{{ config.loading }}" {% endif %}
                     {% if config.decoding %} decoding="{{ config.decoding }}" {% endif %}
                     {% if image.width %} width="{{ image.width }}" {% endif %}
                     {% if image.height %} height="{{ image.height }}" {% endif %}/>
            {% else %}
                {# Standard picture element with format sources #}
                {% if config.avif %}
                    <source srcset="{{ image|toavif }}" type="image/avif"/>
                {% endif %}
                {% if config.webp %}
                    <source srcset="{{ image|towebp }}" type="image/webp"/>
                {% endif %}
                <img {% if config.imgClass %} class="{{ config.imgClass }}" {% endif %}
                     src="{{ image.src }}"
                     {% if image.title %} alt="{{ image.title }}" {% endif %}
                     {% if config.loading %} loading="{{ config.loading }}" {% endif %}
                     {% if config.decoding %} decoding="{{ config.decoding }}" {% endif %}
                     {% if image.width %} width="{{ image.width }}" {% endif %}
                     {% if image.height %} height="{{ image.height }}" {% endif %}/>
            {% endif %}
        </picture>
    {% else %}

    {% set maxResize = 2560 %}
    {% set imageWidth = image.width %}
    {% set imageHeight = image.height %}

    {% set maxDimension = imageWidth > imageHeight ? imageWidth : imageHeight %}
    {% set scaleFactor = maxDimension > maxResize ? (maxResize / maxDimension) : 1 %}

    {% set normalizedSizes = {
        'xs': config.sizes.xs is defined ? config.sizes.xs : [imageWidth],
        'sm': config.sizes.sm is defined ? config.sizes.sm : (config.sizes.xs is defined ? config.sizes.xs : [imageWidth]),
        'md': config.sizes.md is defined ? config.sizes.md : (config.sizes.sm is defined ? config.sizes.sm : (config.sizes.xs is defined ? config.sizes.xs : [imageWidth])),
        'lg': config.sizes.lg is defined ? config.sizes.lg : (config.sizes.md is defined ? config.sizes.md : (config.sizes.sm is defined ? config.sizes.sm : (config.sizes.xs is defined ? config.sizes.xs : [imageWidth]))),
        'xl': config.sizes.xl is defined ? config.sizes.xl : (config.sizes.lg is defined ? config.sizes.lg : (config.sizes.md is defined ? config.sizes.md : (config.sizes.sm is defined ? config.sizes.sm : (config.sizes.xs is defined ? config.sizes.xs : [imageWidth])))),
        '2xl': config.sizes['2xl'] is defined ? config.sizes['2xl'] : (config.sizes.xl is defined ? config.sizes.xl : (config.sizes.lg is defined ? config.sizes.lg : (config.sizes.md is defined ? config.sizes.md : (config.sizes.sm is defined ? config.sizes.sm : (config.sizes.xs is defined ? config.sizes.xs : [imageWidth])))))
    } %}

    {% set sourceConfigs = [
        {
            'key': 'xs',
            'media': '(max-width: ' ~ config.breakpoints.sm ~ ')'
        },
        {
            'key': 'sm',
            'media': '(min-width: ' ~ config.breakpoints.sm ~ ') and (max-width: ' ~ config.breakpoints.md ~ ')'
        },
        {
            'key': 'md',
            'media': '(min-width: ' ~ config.breakpoints.md ~ ') and (max-width: ' ~ config.breakpoints.lg ~ ')'
        },
        {
            'key': 'lg',
            'media': '(min-width: ' ~ config.breakpoints.lg ~ ') and (max-width: ' ~ config.breakpoints.xl ~ ')'
        },
        {
            'key': 'xl',
            'media': '(min-width: ' ~ config.breakpoints.xl ~ ') and (max-width: ' ~ config.breakpoints['2xl'] ~ ')'
        },
        {
            'key': '2xl',
            'media': '(min-width: ' ~ config.breakpoints['2xl'] ~ ')'
        }
    ] %}

    {# Generate resize variants #}
    {% set resizedVariants = {} %}
    {% for source in sourceConfigs %}
        {% set dims = normalizedSizes[source.key] %}
        {% set targetWidth = (dims[0] is defined ? dims[0] : imageWidth) * scaleFactor %}
        {% set targetHeight = dims[1] is defined ? dims[1] * scaleFactor : null %}

        {% set src1x = image|resize(targetWidth, targetHeight) %}
        {% set src2x = image|resize(targetWidth * 2, targetHeight is not null ? targetHeight * 2 : null) %}

        {% set resizedVariants = resizedVariants|merge({
            (source.key): {
                'src1x': src1x,
                'src2x': src2x,
                'media': source.media
            }
        }) %}
    {% endfor %}

    {% set baseSize = normalizedSizes['2xl'] %}
    {% set baseWidth = baseSize[0] %}
    {% set baseHeight = baseSize[1] is defined ? baseSize[1] : null %}

    <picture class="picture {{ config.pictureClass }}">
        {# AVIF sources - grouped by breakpoint #}
        {% if config.avif %}
            {% for source in sourceConfigs %}
                {% set variant = resizedVariants[source.key] %}
                <source {% if variant.media %}media="{{ variant.media }}" {% endif %}
                        srcset="{{ variant.src1x|toavif }} 1x, {{ variant.src2x|toavif }} 2x"
                        type="image/avif"/>
            {% endfor %}
        {% endif %}

        {# WebP sources - grouped by breakpoint #}
        {% if config.webp %}
            {% for source in sourceConfigs %}
                {% set variant = resizedVariants[source.key] %}
                <source {% if variant.media %}media="{{ variant.media }}" {% endif %}
                        srcset="{{ variant.src1x|towebp }} 1x, {{ variant.src2x|towebp }} 2x"
                        type="image/webp"/>
            {% endfor %}
        {% endif %}

        {# Original format sources - fallback #}
        {% for source in sourceConfigs %}
            {% set variant = resizedVariants[source.key] %}
            <source {% if variant.media %}media="{{ variant.media }}" {% endif %}
                    srcset="{{ variant.src1x }} 1x, {{ variant.src2x }} 2x"/>
        {% endfor %}

        {# Fallback img tag #}
        <img {% if config.imgClass %} class="{{ config.imgClass }}" {% endif %}
             src="{{ image|resize(baseWidth, baseHeight) }}"
             {% if image.title %} alt="{{ image.title }}" {% endif %}
             {% if config.loading %} loading="{{ config.loading }}" {% endif %}
             {% if config.decoding %} decoding="{{ config.decoding }}" {% endif %}
             width="{{ baseWidth }}"
             {% if baseHeight %} height="{{ baseHeight }}" {% endif %}/>
    </picture>
    {% endif %}
{% endmacro %}
